<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ - AthReebo</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    header h1 {
      font-size: 2em;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    header p {
      opacity: 0.9;
      margin-top: 10px;
    }
    .main-content {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 30px;
    }
    @media (max-width: 1000px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .panel h2 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 1.2em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #444;
      font-size: 0.9em;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .color-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .color-input-wrapper input[type="color"] {
      width: 50px;
      height: 40px;
      padding: 2px;
      cursor: pointer;
    }
    .color-input-wrapper input[type="text"] {
      flex: 1;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 10px;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      margin-top: 10px;
    }
    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .canvas-wrapper {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      width: 100%;
    }
    #eyecatchCanvas {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .status {
      margin-top: 15px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }
    .status.loading {
      background: #fff3cd;
      color: #856404;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .templates {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .template-btn {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }
    .template-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .template-btn.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }
    .divider {
      border: none;
      border-top: 1px dashed #ddd;
      margin: 25px 0;
    }
    .info-box {
      background: #e8f4fd;
      border: 1px solid #b8daff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #004085;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .hidden {
      display: none !important;
    }
  </style>
  <!-- Google Fonts for Japanese text -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <h1>AthReebo - ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p>Google AI (Imagen 3 / Gemini) ã‚’ä½¿ç”¨ã—ã¦åŒ»ç™‚è¨˜äº‹ç”¨ã®ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒã‚’è‡ªå‹•ç”Ÿæˆ</p>
    </header>

    <div class="main-content">
      <!-- è¨­å®šãƒ‘ãƒãƒ« -->
      <div class="panel">
        <h2>ç”»åƒè¨­å®š</h2>

        <div class="info-box">
          Google AI APIã§å¥³æ€§ã®ç”»åƒã‚’ç”Ÿæˆã—ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ­ã‚´ã‚’åˆæˆã—ã¦ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒã‚’ä½œæˆã—ã¾ã™ã€‚<br><br>
          <strong>æ¨å¥¨ãƒ¢ãƒ‡ãƒ«:</strong> Imagen 3 (å®‰å®šç‰ˆãƒ»ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ãŒç·©ã„)<br>
          <small>â€» Gemini Expãƒ¢ãƒ‡ãƒ«ã¯ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ãŒå³ã—ã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯Imagen 3ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</small>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
        <div class="form-group">
          <label>ã‚«ãƒ©ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
          <div class="templates">
            <button type="button" class="template-btn active" data-template="beige">
              ãƒ™ãƒ¼ã‚¸ãƒ¥
            </button>
            <button type="button" class="template-btn" data-template="blue">
              ãƒ–ãƒ«ãƒ¼
            </button>
            <button type="button" class="template-btn" data-template="green">
              ã‚°ãƒªãƒ¼ãƒ³
            </button>
            <button type="button" class="template-btn" data-template="pink">
              ãƒ”ãƒ³ã‚¯
            </button>
            <button type="button" class="template-btn" data-template="purple">
              ãƒ‘ãƒ¼ãƒ—ãƒ«
            </button>
            <button type="button" class="template-btn" data-template="orange">
              ã‚ªãƒ¬ãƒ³ã‚¸
            </button>
          </div>
        </div>

        <hr class="divider">

        <!-- ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š -->
        <div class="form-group">
          <label>ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«</label>
          <input type="text" id="categoryLabel" value="Skin Care Medicine" placeholder="ä¾‹: Skin Care Medicine">
        </div>

        <div class="form-group">
          <label>ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ1è¡Œç›®ï¼‰</label>
          <input type="text" id="mainTitle" value="ãƒ­ã‚³ã‚¤ãƒ‰è»Ÿè†" placeholder="ä¾‹: ãƒ­ã‚³ã‚¤ãƒ‰è»Ÿè†">
        </div>

        <div class="form-group">
          <label>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ2ã€œ3è¡Œç›®ï¼‰</label>
          <textarea id="subTitle" placeholder="ä¾‹: å‚·å£ã«å¡—ã£ã¦ã‚‚&#10;å¤§ä¸ˆå¤«ï¼Ÿ">å‚·å£ã«å¡—ã£ã¦ã‚‚
å¤§ä¸ˆå¤«ï¼Ÿ</textarea>
        </div>

        <div class="form-group">
          <label>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒãƒŠãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ</label>
          <input type="text" id="bannerText" value="ä½¿ç”¨ç¦æ­¢ã®ç†ç”±ã¨æ³¨æ„ç‚¹" placeholder="ä¾‹: ä½¿ç”¨ç¦æ­¢ã®ç†ç”±ã¨æ³¨æ„ç‚¹">
        </div>

        <hr class="divider">

        <!-- è‰²è¨­å®š -->
        <div class="form-group">
          <label>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼</label>
          <div class="color-input-wrapper">
            <input type="color" id="accentColor" value="#d4a5a5">
            <input type="text" id="accentColorText" value="#d4a5a5" placeholder="#d4a5a5">
          </div>
        </div>

        <div class="form-group">
          <label>æ¥•å††ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ãƒ©ãƒ¼</label>
          <div class="color-input-wrapper">
            <input type="color" id="ellipseColor" value="#8fbc8f">
            <input type="text" id="ellipseColorText" value="#8fbc8f" placeholder="#8fbc8f">
          </div>
        </div>

        <hr class="divider">

        <!-- å¥³æ€§ç”»åƒè¨­å®š -->
        <div class="form-group">
          <label>å¥³æ€§ã®ç‰¹å¾´ï¼ˆGeminiç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</label>
          <textarea id="womanPrompt" rows="3">Professional Japanese woman in her 30s, friendly smile, white medical coat or blouse, clean skin, looking slightly to the left, soft studio lighting, portrait photo</textarea>
        </div>

        <div class="form-group">
          <label>ã¾ãŸã¯ç”»åƒURLã‚’ç›´æ¥æŒ‡å®š</label>
          <input type="text" id="womanImageUrl" placeholder="https://example.com/woman.jpg">
        </div>

        <hr class="divider">

        <!-- APIè¨­å®š -->
        <div class="form-group">
          <label>Google API Key (Gemini)</label>
          <input type="password" id="apiKey" placeholder="AIzaSy...">
        </div>

        <div class="form-group">
          <label>ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«</label>
          <select id="modelSelect">
            <option value="imagen-3.0-generate-002">Imagen 3 (æ¨å¥¨ãƒ»å®‰å®šç‰ˆ)</option>
            <option value="gemini-2.0-flash-preview-image-generation">Gemini 2.0 Flash Preview</option>
            <option value="gemini-2.0-flash-exp-image-generation">Gemini 2.0 Flash Exp (ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ã‚ã‚Š)</option>
          </select>
        </div>

        <button type="button" class="btn btn-primary" id="generateBtn">
          <span class="btn-text">ç”»åƒã‚’ç”Ÿæˆ</span>
          <span class="spinner hidden"></span>
        </button>

        <button type="button" class="btn btn-secondary" id="previewBtn">
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚µãƒ³ãƒ—ãƒ«ç”»åƒã§ç¢ºèªï¼‰
        </button>
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ« -->
      <div class="panel preview-container">
        <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (1200 x 630px)</h2>

        <div class="canvas-wrapper">
          <canvas id="eyecatchCanvas" width="1200" height="630"></canvas>
        </div>

        <div id="status" class="status hidden"></div>

        <button type="button" class="btn btn-success hidden" id="downloadBtn">
          ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>

        <button type="button" class="btn btn-secondary hidden" id="uploadR2Btn">
          R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        </button>
      </div>
    </div>
  </div>

  <!-- QBC Clinic Logo SVG (embedded) -->
  <svg id="qbcLogoSvg" style="display:none" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
    <g fill="#d4a5a5">
      <!-- Simplified QBC logo representation -->
      <path d="M10 10 L10 50 L20 50 L20 35 L30 50 L45 50 L30 30 L30 10 L20 10 L20 25 L10 10 Z"/>
      <text x="50" y="35" font-family="Arial" font-size="18" font-weight="bold" fill="#333">QBCLINIC</text>
      <text x="50" y="50" font-family="Arial" font-size="8" fill="#888">Online medical service</text>
      <text x="50" y="58" font-family="Arial" font-size="8" fill="#888">to get beauty quickly</text>
    </g>
  </svg>

  <script>
    // ã‚«ãƒ©ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    const colorTemplates = {
      beige: {
        bg1: '#f5f0e8',
        bg2: '#ede5d8',
        accent: '#d4a5a5',
        ellipse: '#8fbc8f',
        mainText: '#5a4a3a',
        subText: '#d4a5a5'
      },
      blue: {
        bg1: '#e8f4f8',
        bg2: '#d0e8f0',
        accent: '#5b9bd5',
        ellipse: '#4a90a4',
        mainText: '#2c5282',
        subText: '#5b9bd5'
      },
      green: {
        bg1: '#e8f5e9',
        bg2: '#c8e6c9',
        accent: '#66bb6a',
        ellipse: '#4caf50',
        mainText: '#2e7d32',
        subText: '#66bb6a'
      },
      pink: {
        bg1: '#fce4ec',
        bg2: '#f8bbd9',
        accent: '#ec407a',
        ellipse: '#e91e63',
        mainText: '#ad1457',
        subText: '#ec407a'
      },
      purple: {
        bg1: '#f3e5f5',
        bg2: '#e1bee7',
        accent: '#ab47bc',
        ellipse: '#9c27b0',
        mainText: '#6a1b9a',
        subText: '#ab47bc'
      },
      orange: {
        bg1: '#fff3e0',
        bg2: '#ffe0b2',
        accent: '#ff9800',
        ellipse: '#f57c00',
        mainText: '#e65100',
        subText: '#ff9800'
      }
    };

    let currentTemplate = 'beige';
    let generatedImageUrl = null;

    // DOM elements
    const canvas = document.getElementById('eyecatchCanvas');
    const ctx = canvas.getContext('2d');
    const generateBtn = document.getElementById('generateBtn');
    const previewBtn = document.getElementById('previewBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const uploadR2Btn = document.getElementById('uploadR2Btn');
    const statusEl = document.getElementById('status');

    // Template buttons
    document.querySelectorAll('.template-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTemplate = btn.dataset.template;
        applyTemplate(currentTemplate);
      });
    });

    function applyTemplate(templateName) {
      const t = colorTemplates[templateName];
      document.getElementById('accentColor').value = t.accent;
      document.getElementById('accentColorText').value = t.accent;
      document.getElementById('ellipseColor').value = t.ellipse;
      document.getElementById('ellipseColorText').value = t.ellipse;
    }

    // Color input sync
    document.getElementById('accentColor').addEventListener('input', (e) => {
      document.getElementById('accentColorText').value = e.target.value;
    });
    document.getElementById('accentColorText').addEventListener('input', (e) => {
      document.getElementById('accentColor').value = e.target.value;
    });
    document.getElementById('ellipseColor').addEventListener('input', (e) => {
      document.getElementById('ellipseColorText').value = e.target.value;
    });
    document.getElementById('ellipseColorText').addEventListener('input', (e) => {
      document.getElementById('ellipseColor').value = e.target.value;
    });

    // Draw eyecatch image
    async function drawEyecatch(womanImageSrc) {
      const t = colorTemplates[currentTemplate];
      const accentColor = document.getElementById('accentColor').value;
      const ellipseColor = document.getElementById('ellipseColor').value;

      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Background gradient
      const bgGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      bgGradient.addColorStop(0, t.bg1);
      bgGradient.addColorStop(1, t.bg2);
      ctx.fillStyle = bgGradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw ellipse background for woman (right side)
      const ellipseCenterX = canvas.width - 300;
      const ellipseCenterY = canvas.height / 2 + 20;
      const ellipseRadiusX = 320;
      const ellipseRadiusY = 350;

      ctx.save();
      ctx.beginPath();
      ctx.ellipse(ellipseCenterX, ellipseCenterY, ellipseRadiusX, ellipseRadiusY, 0, 0, Math.PI * 2);
      ctx.fillStyle = ellipseColor;
      ctx.fill();
      ctx.restore();

      // Load and draw woman image
      if (womanImageSrc) {
        try {
          const womanImg = await loadImage(womanImageSrc);

          // Create clipping path for ellipse
          ctx.save();
          ctx.beginPath();
          ctx.ellipse(ellipseCenterX, ellipseCenterY, ellipseRadiusX - 10, ellipseRadiusY - 10, 0, 0, Math.PI * 2);
          ctx.clip();

          // Calculate image dimensions to fit in ellipse
          const imgAspect = womanImg.width / womanImg.height;
          let drawWidth, drawHeight, drawX, drawY;

          if (imgAspect > 1) {
            drawHeight = ellipseRadiusY * 2;
            drawWidth = drawHeight * imgAspect;
          } else {
            drawWidth = ellipseRadiusX * 2;
            drawHeight = drawWidth / imgAspect;
          }

          drawX = ellipseCenterX - drawWidth / 2;
          drawY = ellipseCenterY - drawHeight / 2;

          ctx.drawImage(womanImg, drawX, drawY, drawWidth, drawHeight);
          ctx.restore();
        } catch (err) {
          console.error('Failed to load woman image:', err);
        }
      }

      // Category label (top left)
      const categoryLabel = document.getElementById('categoryLabel').value;
      ctx.font = '500 24px "Noto Sans JP", sans-serif';
      ctx.fillStyle = '#888';
      ctx.fillText(categoryLabel, 50, 50);

      // Main title
      const mainTitle = document.getElementById('mainTitle').value;
      ctx.font = '900 72px "Noto Sans JP", sans-serif';
      ctx.fillStyle = t.mainText;
      ctx.fillText(mainTitle, 50, 140);

      // Sub title (multiple lines)
      const subTitle = document.getElementById('subTitle').value;
      const subLines = subTitle.split('\n');
      ctx.font = '700 56px "Noto Sans JP", sans-serif';
      ctx.fillStyle = t.subText;
      let yPos = 220;
      subLines.forEach(line => {
        ctx.fillText(line, 50, yPos);
        yPos += 70;
      });

      // Accent banner
      const bannerText = document.getElementById('bannerText').value;
      const bannerY = yPos + 20;
      const bannerPadding = 20;
      ctx.font = '700 32px "Noto Sans JP", sans-serif';
      const bannerWidth = ctx.measureText(bannerText).width + bannerPadding * 2;

      // Draw banner background
      ctx.fillStyle = accentColor;
      roundRect(ctx, 50, bannerY - 35, bannerWidth, 55, 8);
      ctx.fill();

      // Draw banner text
      ctx.fillStyle = 'white';
      ctx.fillText(bannerText, 50 + bannerPadding, bannerY);

      // QBC Clinic Logo (bottom left)
      drawQBCLogo(50, canvas.height - 100, accentColor);

      // Show download button
      downloadBtn.classList.remove('hidden');
    }

    function drawQBCLogo(x, y, accentColor) {
      // Logo icon (stylized Q)
      ctx.save();

      // Draw the "q" shape
      ctx.strokeStyle = accentColor;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(x + 20, y + 25, 18, 0, Math.PI * 2);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(x + 30, y + 35);
      ctx.lineTo(x + 40, y + 55);
      ctx.stroke();

      // QBCLINIC text
      ctx.font = 'bold 28px Arial, sans-serif';
      ctx.fillStyle = '#333';
      ctx.fillText('QBCLINIC', x + 55, y + 32);

      // Tagline
      ctx.font = '12px Arial, sans-serif';
      ctx.fillStyle = '#888';
      ctx.fillText('Online medical service', x + 55, y + 50);
      ctx.fillText('to get beauty quickly', x + 55, y + 65);

      ctx.restore();
    }

    function roundRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.classList.remove('hidden');
    }

    function hideStatus() {
      statusEl.classList.add('hidden');
    }

    // Generate with Google AI API (Imagen or Gemini)
    async function generateWithGemini() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const prompt = document.getElementById('womanPrompt').value.trim();
      const selectedModel = document.getElementById('modelSelect').value;

      if (!apiKey) {
        showStatus('Google API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return null;
      }

      showStatus(`${selectedModel}ã§ç”»åƒã‚’ç”Ÿæˆä¸­...`, 'loading');

      try {
        let response;
        let data;

        if (selectedModel.startsWith('imagen')) {
          // Imagen API
          response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:predict?key=${apiKey}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              instances: [{
                prompt: `Generate a high-quality portrait photo: ${prompt}. The image should be suitable for a medical/healthcare website eyecatch banner. Clean, professional look with soft lighting.`
              }],
              parameters: {
                sampleCount: 1,
                aspectRatio: "3:4",
                personGeneration: "allow_adult"
              }
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Imagen API request failed');
          }

          data = await response.json();

          // Extract image from Imagen response
          if (data.predictions && data.predictions[0]?.bytesBase64Encoded) {
            const base64 = data.predictions[0].bytesBase64Encoded;
            return `data:image/png;base64,${base64}`;
          }

        } else {
          // Gemini API with image generation
          response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: `Generate a high-quality portrait photo: ${prompt}. The image should be suitable for a medical/healthcare website eyecatch banner. Clean, professional look with soft lighting.`
                }]
              }],
              generationConfig: {
                responseModalities: ["TEXT", "IMAGE"]
              }
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            const errorMsg = errorData.error?.message || 'API request failed';

            // ã‚¯ã‚©ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€åˆ¥ãƒ¢ãƒ‡ãƒ«ã‚’ææ¡ˆ
            if (errorMsg.includes('quota') || errorMsg.includes('Quota')) {
              throw new Error(`${errorMsg}\n\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒ¢ãƒ‡ãƒ«ã‚’ã€ŒImagen 3ã€ã«å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚`);
            }
            throw new Error(errorMsg);
          }

          data = await response.json();

          // Extract image from Gemini response
          if (data.candidates && data.candidates[0]?.content?.parts) {
            for (const part of data.candidates[0].content.parts) {
              if (part.inlineData?.mimeType?.startsWith('image/')) {
                const base64 = part.inlineData.data;
                const mimeType = part.inlineData.mimeType;
                return `data:${mimeType};base64,${base64}`;
              }
            }
          }
        }

        throw new Error('ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã‹ã€åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
      } catch (error) {
        console.error('API error:', error);
        showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        return null;
      }
    }

    // Preview with sample image
    previewBtn.addEventListener('click', async () => {
      const customUrl = document.getElementById('womanImageUrl').value.trim();
      const sampleUrl = customUrl || 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=600&h=800&fit=crop';

      showStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...', 'loading');

      try {
        await drawEyecatch(sampleUrl);
        showStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†', 'success');
        setTimeout(hideStatus, 2000);
      } catch (error) {
        showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    });

    // Generate with Gemini
    generateBtn.addEventListener('click', async () => {
      const btnText = generateBtn.querySelector('.btn-text');
      const spinner = generateBtn.querySelector('.spinner');

      generateBtn.disabled = true;
      btnText.textContent = 'ç”Ÿæˆä¸­...';
      spinner.classList.remove('hidden');

      try {
        const customUrl = document.getElementById('womanImageUrl').value.trim();
        let imageUrl;

        if (customUrl) {
          imageUrl = customUrl;
        } else {
          imageUrl = await generateWithGemini();
        }

        if (imageUrl) {
          generatedImageUrl = imageUrl;
          await drawEyecatch(imageUrl);
          showStatus('ç”»åƒç”Ÿæˆå®Œäº†ï¼', 'success');
          uploadR2Btn.classList.remove('hidden');
        }
      } catch (error) {
        showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      } finally {
        generateBtn.disabled = false;
        btnText.textContent = 'ç”»åƒã‚’ç”Ÿæˆ';
        spinner.classList.add('hidden');
      }
    });

    // Download
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `eyecatch-${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // R2 Configuration
    const R2_CONFIG = {
      accessKeyId: '70e715ef1d6bbe0c789138f66cbcf85e',
      secretAccessKey: 'f0bfba362e3b7b9db99207f38f6456b44d9ad35dc6ccc04197949e14e1541579',
      accountId: 'f93a9912111d3c99750f928d71ebc4bd',
      bucket: 'fundit',
      publicUrl: 'https://pub-72bbcf8e61fe4f5c89e5b1d0b6409eae.r2.dev'
    };

    // AWS Signature Version 4 Helper Functions
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function sha256Bytes(data) {
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function hmacSha256(key, message) {
      const keyBuffer = typeof key === 'string' ? new TextEncoder().encode(key) : key;
      const messageBuffer = new TextEncoder().encode(message);

      const cryptoKey = await crypto.subtle.importKey(
        'raw', keyBuffer, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
      );

      const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageBuffer);
      return new Uint8Array(signature);
    }

    async function getSignatureKey(secretKey, dateStamp, region, service) {
      const kDate = await hmacSha256('AWS4' + secretKey, dateStamp);
      const kRegion = await hmacSha256(kDate, region);
      const kService = await hmacSha256(kRegion, service);
      const kSigning = await hmacSha256(kService, 'aws4_request');
      return kSigning;
    }

    function getAmzDate() {
      const now = new Date();
      return now.toISOString().replace(/[:-]|\.\d{3}/g, '');
    }

    function getDateStamp() {
      const now = new Date();
      return now.toISOString().slice(0, 10).replace(/-/g, '');
    }

    // Upload to R2
    async function uploadToR2(imageBlob, fileName) {
      const region = 'auto';
      const service = 's3';
      const host = `${R2_CONFIG.accountId}.r2.cloudflarestorage.com`;
      const endpoint = `https://${host}`;
      const objectKey = `eyecatch/${fileName}`;

      const amzDate = getAmzDate();
      const dateStamp = getDateStamp();

      // Read blob as ArrayBuffer for hashing
      const arrayBuffer = await imageBlob.arrayBuffer();
      const payloadHash = await sha256Bytes(arrayBuffer);

      // Canonical request
      const method = 'PUT';
      const canonicalUri = `/${R2_CONFIG.bucket}/${objectKey}`;
      const canonicalQueryString = '';

      const headers = {
        'host': host,
        'x-amz-content-sha256': payloadHash,
        'x-amz-date': amzDate,
        'content-type': 'image/png',
        'content-length': imageBlob.size.toString()
      };

      const sortedHeaders = Object.keys(headers).sort();
      const canonicalHeaders = sortedHeaders.map(key => `${key}:${headers[key]}\n`).join('');
      const signedHeaders = sortedHeaders.join(';');

      const canonicalRequest = [
        method,
        canonicalUri,
        canonicalQueryString,
        canonicalHeaders,
        signedHeaders,
        payloadHash
      ].join('\n');

      // String to sign
      const algorithm = 'AWS4-HMAC-SHA256';
      const credentialScope = `${dateStamp}/${region}/${service}/aws4_request`;
      const canonicalRequestHash = await sha256(canonicalRequest);

      const stringToSign = [
        algorithm,
        amzDate,
        credentialScope,
        canonicalRequestHash
      ].join('\n');

      // Calculate signature
      const signingKey = await getSignatureKey(R2_CONFIG.secretAccessKey, dateStamp, region, service);
      const signatureBytes = await hmacSha256(signingKey, stringToSign);
      const signature = Array.from(signatureBytes).map(b => b.toString(16).padStart(2, '0')).join('');

      // Authorization header
      const authorizationHeader = `${algorithm} Credential=${R2_CONFIG.accessKeyId}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;

      // Make the request
      const response = await fetch(`${endpoint}/${R2_CONFIG.bucket}/${objectKey}`, {
        method: 'PUT',
        headers: {
          'Authorization': authorizationHeader,
          'x-amz-content-sha256': payloadHash,
          'x-amz-date': amzDate,
          'Content-Type': 'image/png',
          'Content-Length': imageBlob.size.toString()
        },
        body: imageBlob
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`R2 upload failed: ${response.status} - ${errorText}`);
      }

      return `${R2_CONFIG.publicUrl}/${objectKey}`;
    }

    // R2 Upload button handler
    uploadR2Btn.addEventListener('click', async () => {
      uploadR2Btn.disabled = true;
      uploadR2Btn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      showStatus('R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'loading');

      try {
        // Convert canvas to blob
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/png');
        });

        // Generate unique filename
        const timestamp = Date.now();
        const mainTitle = document.getElementById('mainTitle').value.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_');
        const fileName = `${mainTitle}_${timestamp}.png`;

        // Upload to R2
        const publicUrl = await uploadToR2(blob, fileName);

        showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼\nURL: ${publicUrl}`, 'success');

        // Copy URL to clipboard
        try {
          await navigator.clipboard.writeText(publicUrl);
          showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ\n${publicUrl}`, 'success');
        } catch (e) {
          // Clipboard access might fail in some contexts
        }

        console.log('Uploaded to R2:', publicUrl);

      } catch (error) {
        console.error('R2 upload error:', error);
        showStatus(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      } finally {
        uploadR2Btn.disabled = false;
        uploadR2Btn.textContent = 'R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
      }
    });

    // Initial preview
    applyTemplate('beige');
    drawEyecatch(null);
  </script>
</body>
</html>
